<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <link rel="stylesheet" type="text/css" href="/main.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/pygment_trac.css" media="screen" />
        <title>Luke Mallon (Nalum)</title>
        <link rel="stylesheet" href="/js/styles/default.css">
        <link rel="stylesheet" href="/js/styles/solarized_dark.css">
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </head>
    <body>
        <!-- HEADER -->
        <div id="header_wrap" class="outer">
            <header class="inner">
                <a id="forkme_banner" href="https://github.com/Nalum">View on GitHub</a>
                <a id="back_banner" href="http://www.lukemallon.com">Back</a>
                <h1 id="project_title">Luke Mallon (Nalum)</h1>
                <h2 id="project_tagline">Senior Software Engineer at <a href="http://www.axonista.com" target="_blank">Axonista</a></h2>
            </header>
        </div>
        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="outer">
            <section id="main_content" class="inner">
                <h2>AWS Elastic Beanstalk and Python 2.7</h2>
                <p>
                    I've been looking at AWS Elastic Beanstalk (EB) and trying to
                    get it up and running. I've found, so far, that I can do so
                    simply enough. Using the <a href="http://aws.amazon.com/cli/">
                    Python CLI Tool Kit</a> is quite nice, and the documentation
                    looks like it's starting to take shape. There still seems to
                    be some issues with it so I wont be using it for the moment.
                </p>
                <p>
                    Using the AWS Console we can setup an EB Application and
                    Environment and then switch out the Default AMI (<code>ami-c37474b7</code>)
                    for a custom AMI based on the Default AMI. In this case the
                    Default AMI is the 64bit Amazon Linux AMI with Python 2.6,
                    version 2012.09. The latest version is not selectable yet,
                    though you can update to it using <code>yum update</code>.
                </p>
                <p>
                    What I am trying to do here is get Python 2.7 setup as the
                    default instead of Python 2.6. I have successfully done this
                    using the method below. There is one issue that I've found
                    with this method and that is if there is an update for python
                    2.6 it reverses some of the changes made. I'll mark that out
                    below when going through the steps.
                </p>
                <p>
                    So to start with, you want to create a new instance of
                    <code>ami-c37474b7</code>. Now you want to do this through
                    the EC2 interface and not the EB interface as we will be
                    creating our own AMI based on the changes that we make.
                </p>
                <p>
                    Once the machine is booted get the generated URL/IP and ssh
                    into it. Once you have ssh'd in run the following set of
                    commands.
                </p>
                <p>
                    When I did this first, I ran the update after completing
                    the steps which then undid part of it. So I've moved the
                    update to the first thing to be done. Note: All commands
                    should be run as the root user.
                </p>
                <pre>/home/ec2-user<code>
yum update
yum install gcc python27 python27-devel httpd-devel make
cp -r -f /usr/lib/python2.6/site-packages/* /usr/lib/python2.7/site-packages/
cp -r -f /usr/lib64/python2.6/site-packages/* /usr/lib64/python2.7/site-packages/
rm -f /usr/bin/python /usr/bin/python2 /usr/bin/pydoc /usr/bin/pydoc2 /usr/bin/python-config /usr/bin/python-config2
                </code></pre>
                <p>
                    These next set of commands make Python 2.7 the default and are
                    what the update undid. So it is up to you if you want to
                    do this part or not.
                </p>
                <pre>/usr/bin<code>
ln -s python2.7 python
ln -s python2.7 python2
ln -s pydoc27 pydoc
ln -s pydoc27 pydoc2
ln -s python2.7-config python-config
ln -s python2.7-config python-config2
                </code></pre>
                <p>
                    Once that is done we then update the easy_install command so
                    that it will use Python 2.7. If you ran the above symlink commands
                    then update easy_install to run off <code>/usr/bin/python</code>
                    other wise update it to run off <code>/usr/bin/python2.7</code>.
                    I did not see it but I would guess that a <code>yum update</code>
                    to easy_install would over write this change also.
                </p>
                <pre>/usr/bin/easy_install<code>
1c1
&lt; #!/usr/bin/python2.6
---
&gt; #!/usr/bin/python
                </code></pre>
                <p>
                    With the above change done we can now install pip.
                </p>
                <pre>/usr/bin<code>
easy_install pip
                </code></pre>
                <p>
                    If you try running python directly now you will be running
                    2.7 but if you try running a wsgi application you will be
                    running 2.6 still. So we need to get mod_wsgi to run with
                    2.7, this means compiling our own version of mod_wsgi to run
                    against 2.7 instead of 2.6.
                </p>
                <p>
                    This shouldn't be too dificult. At the beginning of this we
                    installed gcc, python27-devel and httpd-devel. These are required
                    to build the new version of mod_wsgi that runs against 2.7.
                </p>
                <pre>/home/ec2-user<code>
curl -o mod_wsgi-3.4.tar.gz https://modwsgi.googlecode.com/files/mod_wsgi-3.4.tar.gz
tar xvzf mod_wsgi-3.4.tar.gz
cd mod_wsgi-3.4
./configure --with-python=/usr/bin/python # Note: Use python2.7 if you didn't run the symlink commands above.
make install
                </code></pre>
                <p>
                    Next we want to update the wsgi.conf file so it uses the new
                    configured mod_wsgi.so above and python 2.7
                </p>
                <pre>/etc/httpd/conf.d/wsgi.conf<code>
2c2
&lt; LoadModule wsgi_module "/usr/lib64/httpd/modules/mod_wsgi.so"
---
&gt; LoadModule wsgi_module "/home/ec2-user/mod_wsgi-3.4/.libs/mod_wsgi.so"
9,10c9,10
&lt; Alias /static /opt/python/current/app/
&lt; &lt;Directory /opt/python/current/app/&gt;
---
&gt; Alias /static /opt/python/current/app/static
&gt; &lt;Directory /opt/python/current/app/static&gt;
25c25
&lt;   python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.6/site-packages user=wsgi group=wsgi \
---
&gt;   python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.7/site-packages user=wsgi group=wsgi \
                </code></pre>
                <p>
                    With that done <code>mod_wsgi.so</code> is going to look for
                    the python packages in <code>/opt/python/run/venv/lib/python2.7/site-packages</code>
                    so we need to create these folders <code>python2.7/site-packages</code>
                    but we are going to do that in <code>/opt/python/run/baselinenv</code>.
                    We also need to update apply the following patches to <code>/opt/python/run/baselinenv/bin/easy_install</code>
                    and <code>/opt/python/run/baselinenv/bin/pip</code> and create
                    a new symlink to <code>/usr/bin/python</code>.
                </p>
                <pre>/opt/python/run/baselinenv/bin<code>
                    rm ./python
                    ln -s /usr/bin/python
                </code></pre>
                <pre>/opt/python/run/baselinenv/bin/easy_install<code>
1c1
&lt; #!/usr/bin/python2.6
---
&gt; #!/usr/bin/python
                </code></pre>
                <pre>/opt/python/run/baselinenv/bin/pip<code>
1c1
&lt; #!/usr/bin/python2.6
---
&gt; #!/usr/bin/python
                </code></pre>
            </section>
        </div>
        <!-- FOOTER  -->
        <div id="footer_wrap" class="outer">
            <footer class="inner">
                <p class="copyright">lukemallon.com maintained by <a href="https://github.com/Nalum">Nalum</a></p>
                <iframe style="border: 0; margin: 0; padding: 0;" src="https://www.gittip.com/Nalum/widget.html" width="48pt" height="22pt"></iframe>
            </footer>
        </div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-40128203-1', 'lukemallon.com');
            ga('send', 'pageview');
        </script>
    </body>
</html>
