<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <link rel="stylesheet" type="text/css" href="/main.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/pygment_trac.css" media="screen" />
        <title>Luke Mallon (Nalum)</title>
        <link rel="stylesheet" href="/js/styles/default.css">
        <link rel="stylesheet" href="/js/styles/solarized_dark.css">
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </head>
    <body>
        <!-- HEADER -->
        <div id="header_wrap" class="outer">
            <header class="inner">
                <a id="forkme_banner" href="https://github.com/Nalum">View on GitHub</a>
                <a id="back_banner" href="http://www.lukemallon.com">Back</a>
                <h1 id="project_title">Luke Mallon (Nalum)</h1>
                <h2 id="project_tagline">Senior Software Engineer at <a href="http://www.axonista.com" target="_blank">Axonista</a></h2>
            </header>
        </div>
        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="outer">
            <section id="main_content" class="inner">
                <h2>AWS Elastic Beanstalk and Python 2.7</h2>
                <p>
                    I've been looking at AWS Elastic Beanstalk (EB) and trying to
                    get it up and running. I've found, so far, that I can do so
                    simply enough. Using the <a href="http://aws.amazon.com/cli/">
                    Python CLI Tool Kit</a> is quite nice, and the documentation
                    looks like it's starting to take shape. There still seems to
                    be some issues with it so I wont be using it for the moment.
                </p>
                <p>
                    Using the AWS Console we can setup an EB Application and
                    Environment and then switch out the Default AMI (<code>ami-c37474b7</code>)
                    for a custom AMI based on the Default AMI. In this case the
                    Default AMI is the 64bit Amazon Linux AMI with Python 2.6,
                    version 2012.09. The latest version is not selectable yet,
                    though you can update to it using <code>yum update</code>.
                </p>
                <p>
                    So I'm going to run through setting up Python 2.7 as the
                    default instead of Python 2.6. I have successfully done this
                    using the method below.
                </p>
                <p>
                    To start with, you want to create a new instance of
                    <code>ami-c37474b7</code> I've been told that you need to do
                    this through the EC2 interface rather than the EB interface
                    but I've found that if you do it that way you don't get all
                    the software needed on the system to get it up and running as
                    an EB instance.
                </p>
                <p>
                    So create your application and create a temporary environment.
                    Once the machine is booted get the generated URL/IP and ssh
                    into it. Once you have ssh'd in run the following set of
                    commands.
                </p>
                <pre>cd /home/ec2-user<code>yum update
yum install gcc python27 python27-devel httpd-devel make</code></pre>
                <p>
                    These next set of commands make Python 2.7 the default.
                </p>
                <pre>cd /usr/bin<code>rm -f /usr/bin/python /usr/bin/python2 /usr/bin/pydoc /usr/bin/pydoc2 /usr/bin/python-config /usr/bin/python-config2
ln -s python2.7 python
ln -s python2.7 python2
ln -s pydoc27 pydoc
ln -s pydoc27 pydoc2
ln -s python2.7-config python-config
ln -s python2.7-config python-config2</code></pre>
                <p>
                    Now we want to update <code>easy_install</code> to the latest
                    version, install <code>pip</code> and install <code>virtualenv</code>
                    via <code>pip</code>.
                </p>
                <pre>cd /opt<code>wget https://bitbucket.org/pypa/setuptools/raw/bootstrap/ez_setup.py -O - | python
easy_install pip
pip install virtualenv</code></pre>
                <p>
                    There are still some things that are missing from our Python
                    2.7 install that are required for <code>yum</code> and the
                    aws tools. So we are going to copy those from the Python 2.6
                    install. If you are asked to overwrite anything say no.
                </p>
                <pre><code>cp -r /usr/lib/python2.6/site-packages/* /usr/lib/python2.7/site-packages/
cp -r /usr/lib64/python2.6/site-packages/* /usr/lib64/python2.7/site-packages/</code></pre>
                <p>
                    We need to get <code>mod_wsgi</code> to run with 2.7,
                    this means compiling our own version of <code>mod_wsgi</code>
                    to run against 2.7 instead of 2.6. This shouldn't be too dificult.
                </p>
                <p>
                    Along with <code>python2.7</code> we just installed <code>gcc</code>,
                    <code>python27-devel</code>, <code>httpd-devel</code> and
                    <code>make</code>. These are required to build the new version
                    of <code>mod_wsgi</code> that runs against 2.7.
                </p>
                <p>
                    Now we will download, untar, configure and <code>make install</code>
                    the new version of <code>mod_wsgi</code> for Python 2.7.
                </p>
                <pre>cd /opt<code>curl -o mod_wsgi-3.4.tar.gz https://modwsgi.googlecode.com/files/mod_wsgi-3.4.tar.gz
tar xvzf mod_wsgi-3.4.tar.gz
cd mod_wsgi-3.4
./configure --with-python=/usr/bin/python2.7
make install</code></pre>
                <p>
                    Next we want to update the <code>wsgi.conf</code> file so it
                    uses the new configured <code>mod_wsgi.so</code> above and
                    Python 2.7. In my case I am also updating the location of the
                    wsgi static folder. You will also need to remove the compiled
                    version of the file<br><code>rm /opt/elasticbeanstalk/hooks/config.pyc</code>.
                </p>
                <pre>diff /opt/elasticbeanstalk/hooks/config.py<code>32c32
&lt; LoadModule wsgi_module modules/mod_wsgi.so
---
&gt; LoadModule wsgi_module /opt/mod_wsgi-3.4/.libs/mod_wsgi.so
50c50
&lt;   python-path=%s:/opt/python/run/venv/lib/python2.6/site-packages user=wsgi group=wsgi \
---
&gt;   python-path=%s:/opt/python/run/venv/lib/python2.7/site-packages user=wsgi group=wsgi \
140,141c140,141
&lt;         contents.append('Alias %s %s' % (key, os.path.join(APP_DIR, value)))
&lt;         contents.append('&lt;Directory %s&gt;' % os.path.join(APP_DIR, value))
---
&gt;         contents.append('Alias %s %sstatic' % (key, os.path.join(APP_DIR, value)))
&gt;         contents.append('&lt;Directory %sstatic&gt;' % os.path.join(APP_DIR, value))</code></pre>
                <p>
                    With that done we want to update the python virtual environments
                    to use Python 2.7.
                </p>
                <pre>cd /opt/python/run<code>virtualenv baselinenv
virtualenv venv</code></pre>
                <p>
                    Now we want to deploy a version of our app. You can do this
                    by uploading a ZIP file through the AWS EB Console or if you
                    have the EB CLI Tool installed you can use the git command
                    <code>git aws.push --environment test-env</code>.
                </p>
                <p>
                    And that's it, you now have Elastic Beanstalk setup with
                    Amazon Linux AMI Python 2.7.
                </p>
            </section>
        </div>
        <!-- FOOTER  -->
        <div id="footer_wrap" class="outer">
            <footer class="inner">
                <p class="copyright">lukemallon.com maintained by <a href="https://github.com/Nalum">Nalum</a></p>
                <iframe style="border: 0; margin: 0; padding: 0;" src="https://www.gittip.com/Nalum/widget.html" width="48pt" height="22pt"></iframe>
            </footer>
        </div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-40128203-1', 'lukemallon.com');
            ga('send', 'pageview');
        </script>
    </body>
</html>
